services:
  postgres-db:
    image: postgres:16-alpine
    container_name: postgres-db
    environment:
      POSTGRES_USER: mechanus
      POSTGRES_PASSWORD: mechanus_test
      POSTGRES_DB: mechanus_test
    ports:
      - "5432:5432"
    networks:
      - mechanus-public
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mechanus"]
      interval: 5s
      timeout: 5s
      retries: 5

  mechanus-server:
    image: mechanus:latest
    build:
      context: ..
      tags:
        - mechanus
      dockerfile: Dockerfile
    container_name: mechanus-server
    environment:
      # PostgreSQL database configuration
      DATABASE_TYPE: postgres
      # Note: sslmode=disable is used for testing to simplify setup. For production, use sslmode=require
      DATABASE_DSN: "host=postgres-db user=mechanus password=mechanus_test dbname=mechanus_test port=5432 sslmode=disable"
      LOG_LEVEL: debug
      LOG_FORMAT: text
      LOG_REPORT_CALLER: "true"
      # Inits for database
      INITIALIZE_ADMIN_USERNAME: admin
      INITIALIZE_ADMIN_PASSWORD: admin
    command: ./mechanus server --log.level debug --log.format text --log.report-caller
    ports:
      - "8080:8080"
      - "8443:8443"
    restart: unless-stopped
    networks:
      - mechanus-public
    depends_on:
      postgres-db:
        condition: service_healthy

networks:
  mechanus-public:
    driver: bridge
    # This network is attachable and accessible for development
    attachable: true
